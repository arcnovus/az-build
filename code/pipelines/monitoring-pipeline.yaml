# Azure Pipeline to deploy Monitoring Infrastructure using Deployment Stacks
# This pipeline deploys the monitoring Bicep template as a Deployment Stack at subscription scope
# Deploys centralized Log Analytics workspace, Action Groups, and Alert Rules
#
# Parameter Placement Strategy:
# - Stable configuration (SKU, thresholds, security settings) is in bicepparam files
# - String values that need organization-wide updates (subscription ID, emails, SMS) are in monitoring-variables
# - Values that change per run (environment, location) are pipeline parameters
#
# Security Note:
# Public network access controls data plane operations (log queries) only.
# ARM API deployments work regardless of publicNetworkAccess setting.
# Microsoft-hosted agents can deploy even with publicNetworkAccess='Disabled'.

trigger: none
pr: none

pool:
  vmImage: "ubuntu-latest"

variables:
  - group: common-variables
  - group: monitoring-variables
  - name: bicepPath
    value: "code/bicep/monitoring"
  - name: templateFile
    value: "$(bicepPath)/monitoring.bicep"
  - name: parametersFile
    value: "$(bicepPath)/monitoring.bicepparam"
  - name: stackName
    value: "stack-monitoring-${{ parameters.environment }}-${{ parameters.locationCode }}-${{ parameters.instanceNumber }}"

parameters:
  # ============================================================================
  # CORE NAMING PARAMETERS (vary per deployment)
  # ============================================================================
  - name: workloadAlias
    displayName: "Workload Alias"
    type: string
    default: "monitoring"
  - name: environment
    displayName: "Environment"
    type: string
    default: "live"
    values:
      - nonprod
      - dev
      - test
      - uat
      - staging
      - prod
      - live
  - name: locationCode
    displayName: "Location Code (e.g., cac for canada central)"
    type: string
    default: "cac"
  - name: instanceNumber
    displayName: "Instance Number (e.g., 001 for the first instance)"
    type: string
    default: "001"
  - name: location
    displayName: "Azure Region"
    type: string
    default: "canadacentral"

  # ============================================================================
  # WORKSPACE CONFIGURATION (may vary by environment)
  # ============================================================================
  - name: dataRetention
    displayName: "Data Retention (days, 30-730)"
    type: number
    default: 60
  - name: dailyQuotaGb
    displayName: "Daily Quota (GB, -1 for unlimited)"
    type: number
    default: -1

  # ============================================================================
  # OWNERSHIP PARAMETERS
  # ============================================================================
  - name: managedBy
    displayName: "Managed By"
    type: string
    default: "$(managedBy)"
  - name: owner
    displayName: "Owner (e.g. a group mailbox like platform-team@organization.com)"
    type: string
    default: "$(defaultOwner)"

  # ============================================================================
  # DEPLOYMENT STACK SETTINGS
  # ============================================================================
  - name: denySettingsMode
    displayName: "Deny Settings Mode"
    type: string
    default: "denyWriteAndDelete"
    values:
      - none
      - denyDelete
      - denyWriteAndDelete
  - name: actionOnUnmanage
    displayName: "Action on Unmanaged Resources"
    type: string
    default: "detachAll"
    values:
      - deleteResources
      - deleteAll
      - detachAll
  - name: deploymentStage
    displayName: "Pipeline Stage to Run"
    type: string
    default: "WhatIf"
    values:
      - Validation
      - WhatIf
      - Deploy

stages:
  - stage: Validate
    displayName: "Validate Deployment Stack"
    # Runs for: Validation, WhatIf, Deploy (all options)
    jobs:
      - template: templates/jobs/validate-environment-job.yaml
        parameters:
          environment: ${{ parameters.environment }}
      - job: ValidateStack
        displayName: "Validate Stack"
        dependsOn: ValidateEnvironment
        steps:
          - checkout: self

          - script: |
              # Validate that monitoringSubscriptionId is set in the variable group
              if [ -z "$(monitoringSubscriptionId)" ]; then
                echo "##[error]monitoringSubscriptionId is not set in the monitoring-variables variable group."
                echo "Please set the subscription ID in the variable group before running this pipeline."
                exit 1
              fi
              echo "âœ“ Monitoring subscription ID: $(monitoringSubscriptionId)"
            displayName: "Validate Subscription ID"

          - task: AzureCLI@2
            displayName: "Validate Monitoring Deployment Stack"
            inputs:
              azureSubscription: "$(azureServiceConnection)"
              scriptType: "bash"
              scriptLocation: "inlineScript"
              inlineScript: |
                # Build parameter overrides for pipeline parameters
                PARAMS=""
                if [ -n "${{ parameters.workloadAlias }}" ]; then
                  PARAMS="$PARAMS --parameters workloadAlias='${{ parameters.workloadAlias }}'"
                fi
                if [ -n "${{ parameters.environment }}" ]; then
                  PARAMS="$PARAMS --parameters environment='${{ parameters.environment }}'"
                fi
                if [ -n "${{ parameters.locationCode }}" ]; then
                  PARAMS="$PARAMS --parameters locationCode='${{ parameters.locationCode }}'"
                fi
                if [ -n "${{ parameters.instanceNumber }}" ]; then
                  PARAMS="$PARAMS --parameters instanceNumber='${{ parameters.instanceNumber }}'"
                fi
                if [ -n "${{ parameters.location }}" ]; then
                  PARAMS="$PARAMS --parameters location='${{ parameters.location }}'"
                fi
                if [ -n "${{ parameters.dataRetention }}" ]; then
                  PARAMS="$PARAMS --parameters dataRetention=${{ parameters.dataRetention }}"
                fi
                if [ -n "${{ parameters.dailyQuotaGb }}" ]; then
                  PARAMS="$PARAMS --parameters dailyQuotaGb=${{ parameters.dailyQuotaGb }}"
                fi
                if [ -n "${{ parameters.owner }}" ]; then
                  PARAMS="$PARAMS --parameters owner='${{ parameters.owner }}'"
                fi
                if [ -n "${{ parameters.managedBy }}" ]; then
                  PARAMS="$PARAMS --parameters managedBy='${{ parameters.managedBy }}'"
                fi

                # Convert comma-separated email list from variable group to JSON array for Bicep
                # Format: "email1@example.com,email2@example.com" -> JSON array of receiver objects
                EMAIL_RECEIVERS="[]"
                if [ -n "$(actionGroupEmails)" ]; then
                  EMAIL_RECEIVERS="["
                  IFS=',' read -ra EMAILS <<< "$(actionGroupEmails)"
                  FIRST=true
                  for email in "${EMAILS[@]}"; do
                    email=$(echo "$email" | xargs)  # Trim whitespace
                    if [ -n "$email" ]; then
                      if [ "$FIRST" = true ]; then
                        FIRST=false
                      else
                        EMAIL_RECEIVERS+=","
                      fi
                      EMAIL_RECEIVERS+="{\"name\":\"${email%%@*}\",\"emailAddress\":\"${email}\",\"useCommonAlertSchema\":true}"
                    fi
                  done
                  EMAIL_RECEIVERS+="]"
                fi

                # Convert comma-separated SMS list from variable group to JSON array for Bicep
                # Format: "1:5551234567,1:5559876543" -> JSON array of SMS receiver objects
                SMS_RECEIVERS="[]"
                if [ -n "$(actionGroupSmsNumbers)" ]; then
                  SMS_RECEIVERS="["
                  IFS=',' read -ra SMS_LIST <<< "$(actionGroupSmsNumbers)"
                  FIRST=true
                  for sms in "${SMS_LIST[@]}"; do
                    sms=$(echo "$sms" | xargs)  # Trim whitespace
                    if [ -n "$sms" ]; then
                      IFS=':' read -r country phone <<< "$sms"
                      if [ -n "$country" ] && [ -n "$phone" ]; then
                        if [ "$FIRST" = true ]; then
                          FIRST=false
                        else
                          SMS_RECEIVERS+=","
                        fi
                        SMS_RECEIVERS+="{\"name\":\"SMS-${phone}\",\"countryCode\":\"${country}\",\"phoneNumber\":\"${phone}\"}"
                      fi
                    fi
                  done
                  SMS_RECEIVERS+="]"
                fi

                # Write array values to temp files (one value per file) to avoid shell escaping issues
                # When using .bicepparam files, we pass arrays as: paramName=@file (where file contains just the JSON array)
                EMAIL_FILE=$(mktemp)
                SMS_FILE=$(mktemp)
                echo "${EMAIL_RECEIVERS}" > "$EMAIL_FILE"
                echo "${SMS_RECEIVERS}" > "$SMS_FILE"

                az stack sub validate \
                  --name "stack-${{ parameters.workloadAlias }}-${{ parameters.environment }}-${{ parameters.locationCode }}-${{ parameters.instanceNumber }}" \
                  --subscription "$(monitoringSubscriptionId)" \
                  --location $(deploymentLocation) \
                  --template-file $(templateFile) \
                  --parameters $(parametersFile) \
                  --parameters actionGroupEmailReceivers=@"$EMAIL_FILE" \
                  --parameters actionGroupSmsReceivers=@"$SMS_FILE" \
                  --deny-settings-mode ${{ parameters.denySettingsMode }} \
                  --action-on-unmanage ${{ parameters.actionOnUnmanage }} \
                  $PARAMS

                rm -f "$EMAIL_FILE" "$SMS_FILE"

  - stage: WhatIf
    displayName: "What-If Analysis"
    dependsOn:
      - Validate
    # Runs for: WhatIf, Deploy
    condition: |
      and(
        eq(dependencies.Validate.result, 'Succeeded'),
        in('${{ parameters.deploymentStage }}', 'WhatIf', 'Deploy')
      )
    jobs:
      - job: WhatIfAnalysis
        displayName: "What-If"
        steps:
          - checkout: self

          - task: AzureCLI@2
            displayName: "What-If Monitoring Deployment Stack"
            inputs:
              azureSubscription: "$(azureServiceConnection)"
              scriptType: "bash"
              scriptLocation: "inlineScript"
              inlineScript: |
                # Build parameter overrides for pipeline parameters
                PARAMS=""
                if [ -n "${{ parameters.workloadAlias }}" ]; then
                  PARAMS="$PARAMS --parameters workloadAlias='${{ parameters.workloadAlias }}'"
                fi
                if [ -n "${{ parameters.environment }}" ]; then
                  PARAMS="$PARAMS --parameters environment='${{ parameters.environment }}'"
                fi
                if [ -n "${{ parameters.locationCode }}" ]; then
                  PARAMS="$PARAMS --parameters locationCode='${{ parameters.locationCode }}'"
                fi
                if [ -n "${{ parameters.instanceNumber }}" ]; then
                  PARAMS="$PARAMS --parameters instanceNumber='${{ parameters.instanceNumber }}'"
                fi
                if [ -n "${{ parameters.location }}" ]; then
                  PARAMS="$PARAMS --parameters location='${{ parameters.location }}'"
                fi
                if [ -n "${{ parameters.dataRetention }}" ]; then
                  PARAMS="$PARAMS --parameters dataRetention=${{ parameters.dataRetention }}"
                fi
                if [ -n "${{ parameters.dailyQuotaGb }}" ]; then
                  PARAMS="$PARAMS --parameters dailyQuotaGb=${{ parameters.dailyQuotaGb }}"
                fi
                if [ -n "${{ parameters.owner }}" ]; then
                  PARAMS="$PARAMS --parameters owner='${{ parameters.owner }}'"
                fi
                if [ -n "${{ parameters.managedBy }}" ]; then
                  PARAMS="$PARAMS --parameters managedBy='${{ parameters.managedBy }}'"
                fi

                # Convert comma-separated email list from variable group to JSON array for Bicep
                EMAIL_RECEIVERS="[]"
                if [ -n "$(actionGroupEmails)" ]; then
                  EMAIL_RECEIVERS="["
                  IFS=',' read -ra EMAILS <<< "$(actionGroupEmails)"
                  FIRST=true
                  for email in "${EMAILS[@]}"; do
                    email=$(echo "$email" | xargs)
                    if [ -n "$email" ]; then
                      if [ "$FIRST" = true ]; then
                        FIRST=false
                      else
                        EMAIL_RECEIVERS+=","
                      fi
                      EMAIL_RECEIVERS+="{\"name\":\"${email%%@*}\",\"emailAddress\":\"${email}\",\"useCommonAlertSchema\":true}"
                    fi
                  done
                  EMAIL_RECEIVERS+="]"
                fi

                # Convert comma-separated SMS list from variable group to JSON array for Bicep
                SMS_RECEIVERS="[]"
                if [ -n "$(actionGroupSmsNumbers)" ]; then
                  SMS_RECEIVERS="["
                  IFS=',' read -ra SMS_LIST <<< "$(actionGroupSmsNumbers)"
                  FIRST=true
                  for sms in "${SMS_LIST[@]}"; do
                    sms=$(echo "$sms" | xargs)
                    if [ -n "$sms" ]; then
                      IFS=':' read -r country phone <<< "$sms"
                      if [ -n "$country" ] && [ -n "$phone" ]; then
                        if [ "$FIRST" = true ]; then
                          FIRST=false
                        else
                          SMS_RECEIVERS+=","
                        fi
                        SMS_RECEIVERS+="{\"name\":\"SMS-${phone}\",\"countryCode\":\"${country}\",\"phoneNumber\":\"${phone}\"}"
                      fi
                    fi
                  done
                  SMS_RECEIVERS+="]"
                fi

                # Write array values to temp files (one value per file) to avoid shell escaping issues
                EMAIL_FILE=$(mktemp)
                SMS_FILE=$(mktemp)
                echo "${EMAIL_RECEIVERS}" > "$EMAIL_FILE"
                echo "${SMS_RECEIVERS}" > "$SMS_FILE"

                # Use az deployment sub what-if for what-if analysis
                # (az stack sub create doesn't support --what-if)
                az deployment sub what-if \
                  --name "stack-${{ parameters.workloadAlias }}-${{ parameters.environment }}-${{ parameters.locationCode }}-${{ parameters.instanceNumber }}" \
                  --subscription "$(monitoringSubscriptionId)" \
                  --location $(deploymentLocation) \
                  --template-file $(templateFile) \
                  --parameters $(parametersFile) \
                  --parameters actionGroupEmailReceivers=@"$EMAIL_FILE" \
                  --parameters actionGroupSmsReceivers=@"$SMS_FILE" \
                  $PARAMS

                rm -f "$EMAIL_FILE" "$SMS_FILE"

  - stage: Deploy
    displayName: "Deploy Monitoring Deployment Stack"
    dependsOn:
      - Validate
      - WhatIf
    # Runs for: Deploy only
    condition: |
      and(
        eq(dependencies.Validate.result, 'Succeeded'),
        in(dependencies.WhatIf.result, 'Succeeded', 'Skipped'),
        eq('${{ parameters.deploymentStage }}', 'Deploy')
      )
    jobs:
      - deployment: DeployMonitoringStack
        displayName: "Deploy Monitoring Stack"
        environment: "${{ parameters.environment }}"
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - task: AzureCLI@2
                  displayName: "Deploy Monitoring Deployment Stack"
                  inputs:
                    azureSubscription: "$(azureServiceConnection)"
                    scriptType: "bash"
                    scriptLocation: "inlineScript"
                    inlineScript: |
                      # Build parameter overrides for pipeline parameters
                      PARAMS=""
                      if [ -n "${{ parameters.workloadAlias }}" ]; then
                        PARAMS="$PARAMS --parameters workloadAlias='${{ parameters.workloadAlias }}'"
                      fi
                      if [ -n "${{ parameters.environment }}" ]; then
                        PARAMS="$PARAMS --parameters environment='${{ parameters.environment }}'"
                      fi
                      if [ -n "${{ parameters.locationCode }}" ]; then
                        PARAMS="$PARAMS --parameters locationCode='${{ parameters.locationCode }}'"
                      fi
                      if [ -n "${{ parameters.instanceNumber }}" ]; then
                        PARAMS="$PARAMS --parameters instanceNumber='${{ parameters.instanceNumber }}'"
                      fi
                      if [ -n "${{ parameters.location }}" ]; then
                        PARAMS="$PARAMS --parameters location='${{ parameters.location }}'"
                      fi
                      if [ -n "${{ parameters.dataRetention }}" ]; then
                        PARAMS="$PARAMS --parameters dataRetention=${{ parameters.dataRetention }}"
                      fi
                      if [ -n "${{ parameters.dailyQuotaGb }}" ]; then
                        PARAMS="$PARAMS --parameters dailyQuotaGb=${{ parameters.dailyQuotaGb }}"
                      fi
                      if [ -n "${{ parameters.owner }}" ]; then
                        PARAMS="$PARAMS --parameters owner='${{ parameters.owner }}'"
                      fi
                      if [ -n "${{ parameters.managedBy }}" ]; then
                        PARAMS="$PARAMS --parameters managedBy='${{ parameters.managedBy }}'"
                      fi

                      # Convert comma-separated email list from variable group to JSON array for Bicep
                      EMAIL_RECEIVERS="[]"
                      if [ -n "$(actionGroupEmails)" ]; then
                        EMAIL_RECEIVERS="["
                        IFS=',' read -ra EMAILS <<< "$(actionGroupEmails)"
                        FIRST=true
                        for email in "${EMAILS[@]}"; do
                          email=$(echo "$email" | xargs)
                          if [ -n "$email" ]; then
                            if [ "$FIRST" = true ]; then
                              FIRST=false
                            else
                              EMAIL_RECEIVERS+=","
                            fi
                            EMAIL_RECEIVERS+="{\"name\":\"${email%%@*}\",\"emailAddress\":\"${email}\",\"useCommonAlertSchema\":true}"
                          fi
                        done
                        EMAIL_RECEIVERS+="]"
                      fi

                      # Convert comma-separated SMS list from variable group to JSON array for Bicep
                      SMS_RECEIVERS="[]"
                      if [ -n "$(actionGroupSmsNumbers)" ]; then
                        SMS_RECEIVERS="["
                        IFS=',' read -ra SMS_LIST <<< "$(actionGroupSmsNumbers)"
                        FIRST=true
                        for sms in "${SMS_LIST[@]}"; do
                          sms=$(echo "$sms" | xargs)
                          if [ -n "$sms" ]; then
                            IFS=':' read -r country phone <<< "$sms"
                            if [ -n "$country" ] && [ -n "$phone" ]; then
                              if [ "$FIRST" = true ]; then
                                FIRST=false
                              else
                                SMS_RECEIVERS+=","
                              fi
                              SMS_RECEIVERS+="{\"name\":\"SMS-${phone}\",\"countryCode\":\"${country}\",\"phoneNumber\":\"${phone}\"}"
                            fi
                          fi
                        done
                        SMS_RECEIVERS+="]"
                      fi

                      # Write array values to temp files (one value per file) to avoid shell escaping issues
                      EMAIL_FILE=$(mktemp)
                      SMS_FILE=$(mktemp)
                      echo "${EMAIL_RECEIVERS}" > "$EMAIL_FILE"
                      echo "${SMS_RECEIVERS}" > "$SMS_FILE"

                      az stack sub create \
                        --name "stack-${{ parameters.workloadAlias }}-${{ parameters.environment }}-${{ parameters.locationCode }}-${{ parameters.instanceNumber }}" \
                        --subscription "$(monitoringSubscriptionId)" \
                        --location $(deploymentLocation) \
                        --template-file $(templateFile) \
                        --parameters $(parametersFile) \
                        --parameters actionGroupEmailReceivers=@"$EMAIL_FILE" \
                        --parameters actionGroupSmsReceivers=@"$SMS_FILE" \
                        --deny-settings-mode ${{ parameters.denySettingsMode }} \
                        --action-on-unmanage ${{ parameters.actionOnUnmanage }} \
                        --yes \
                        $PARAMS

                      rm -f "$EMAIL_FILE" "$SMS_FILE"

# Azure Pipeline to deploy Subscription Vending
# This pipeline deploys the sub-vending Bicep template at the tenant scope
# This pipeline is reusable and can be triggered with parameters
#
# =============================================================================
# IMPLEMENTATION NOTE
# =============================================================================
# This implementation uses direct Bicep resource definitions rather than the
# Azure Verified Module (AVM) sub-vending pattern. The AVM module was abandoned
# due to a bug where it referenced an invalid API version (2025-04-01) for
# Microsoft.Management/managementGroups. See sub-vending.bicep for details.
#
# =============================================================================
# RBAC REQUIREMENTS
# =============================================================================
# The service principal used by the Azure service connection requires:
#
#   1. Owner - At Tenant Root MG for subscription creation and MG assignment
#   2. Billing Permissions - Invoice Section Contributor (MCA) or
#                            Enrollment Account Administrator (EA)
#
# Azure RBAC assignment:
#
#   SP_OBJECT_ID="<service-principal-object-id>"
#   TENANT_ROOT_MG=$(az account management-group list \
#     --query "[?displayName=='Tenant Root Group'].name" -o tsv)
#
#   az role assignment create --assignee "$SP_OBJECT_ID" \
#     --role "Owner" \
#     --scope "/providers/Microsoft.Management/managementGroups/$TENANT_ROOT_MG"
#
# Billing permissions must be assigned via Azure Portal:
#   1. Go to Cost Management + Billing
#   2. Navigate to your billing account/invoice section
#   3. Add the SP as Invoice Section Contributor (MCA) or
#      Enrollment Account Administrator (EA)
#
# See docs/RBAC-Requirements.md for full documentation.
# =============================================================================

trigger: none
pr: none

pool:
  vmImage: "ubuntu-latest"

variables:
  - group: common-variables
  - name: bicepPath
    value: "code/bicep/sub-vending"
  - name: templateFile
    value: "$(bicepPath)/sub-vending.bicep"
  - name: parametersFile
    value: "$(bicepPath)/sub-vending.bicepparam"
  - name: scriptsPath
    value: "code/pipelines/scripts"

parameters:
  - name: projectName
    displayName: "Project Name (used for tagging)"
    type: string
    default: ""
  - name: workloadAlias
    displayName: "Workload Alias (used for naming conventions)"
    type: string
    default: ""
  - name: environment
    displayName: "Environment"
    type: string
    default: ""
    values:
      - nonprod
      - dev
      - test
      - uat
      - staging
      - prod
      - live
  - name: locationCode
    displayName: "Location Code (e.g., cac for canada central)"
    type: string
    default: "cac"
  - name: instanceNumber
    displayName: "Instance Number (e.g., 001 for the first instance)"
    type: string
    default: ""
  - name: managementGroupId
    displayName: "Management Group ID"
    type: string
    default: ""
    values:
      - $(azureTenantId)
      - "mg-platform"
      - "mg-landing-zone"
      - "mg-sandbox"
      - "mg-decommissioned"
      - "mg-management"
      - "mg-connectivity"
      - "mg-corp-prod"
      - "mg-corp-non-prod"
      - "mg-online-prod"
      - "mg-online-non-prod"
  - name: workload
    displayName: "Workload Type"
    type: string
    default: "Production"
    values:
      - Production
      - DevTest
  - name: managedBy
    displayName: "Managed By"
    type: string
    default: "$(managedBy)"
  - name: owner
    displayName: "Owner"
    type: string
    default: "$(defaultOwner)"
  - name: deploymentStage
    displayName: "Pipeline Stage to Run"
    type: string
    default: "WhatIf"
    values:
      - Validation
      - WhatIf
      - Deploy

stages:
  - stage: Validate
    displayName: "Validate Bicep Template"
    # Runs for: Validation, WhatIf, Deploy (all options)
    jobs:
      - job: ValidateBicep
        displayName: "Validate Bicep"
        timeoutInMinutes: 25
        steps:
          - checkout: self

          - script: |
              # Validate environment parameter against allowed environments
              ALLOWED_ENVS="$(environments)"
              ENV_PARAM="${{ parameters.environment }}"

              if [ -z "$ENV_PARAM" ]; then
                echo "##[error]Environment parameter is required but was not provided."
                echo "Allowed environments: ${ALLOWED_ENVS}"
                exit 1
              fi

              if [[ ",${ALLOWED_ENVS}," =~ ",${ENV_PARAM}," ]]; then
                echo "✓ Valid environment: ${ENV_PARAM}"
              else
                echo "##[error]Invalid environment: ${ENV_PARAM}"
                echo "Allowed environments: ${ALLOWED_ENVS}"
                exit 1
              fi
            displayName: "Validate Environment Parameter"

          - task: AzureCLI@2
            name: LookupSubscription
            displayName: "Lookup Existing Subscription"
            inputs:
              azureSubscription: "$(azureServiceConnection)"
              scriptType: "bash"
              scriptLocation: "inlineScript"
              inlineScript: |
                bash $(scriptsPath)/lookup-subscription.sh \
                  "${{ parameters.workloadAlias }}" \
                  "${{ parameters.environment }}" \
                  "${{ parameters.locationCode }}" \
                  "${{ parameters.instanceNumber }}"

          - task: AzureCLI@2
            displayName: "Validate Permissions for Subscription Creation"
            inputs:
              azureSubscription: "$(azureServiceConnection)"
              scriptType: "bash"
              scriptLocation: "inlineScript"
              inlineScript: |
                # Get existing subscription ID from lookup step
                EXISTING_SUB_ID="$(LookupSubscription.EXISTING_SUBSCRIPTION_ID)"

                # Only validate permissions when creating new subscriptions
                if [ -z "$EXISTING_SUB_ID" ]; then
                  echo "Validating permissions for new subscription creation..."
                  
                  # Get current service principal object ID
                  SP_OBJECT_ID=$(az ad signed-in-user show --query id -o tsv 2>/dev/null || az account show --query user.name -o tsv)
                  if [ -z "$SP_OBJECT_ID" ]; then
                    echo "##[warning]Could not determine service principal identity. Skipping permission validation."
                    exit 0
                  fi
                  
                  # Get tenant root management group
                  TENANT_ROOT_MG=$(az account management-group list \
                    --query "[?displayName=='Tenant Root Group'].name" -o tsv 2>/dev/null || echo "")
                  
                  if [ -z "$TENANT_ROOT_MG" ]; then
                    echo "##[warning]Could not determine tenant root management group. Skipping permission validation."
                    exit 0
                  fi
                  
                  # Check for Owner role at Tenant Root MG
                  echo "Checking for Owner role at Tenant Root MG..."
                  HAS_OWNER=$(az role assignment list \
                    --assignee "$SP_OBJECT_ID" \
                    --scope "/providers/Microsoft.Management/managementGroups/$TENANT_ROOT_MG" \
                    --query "[?roleDefinitionName=='Owner']" -o tsv 2>/dev/null || echo "")
                  
                  if [ -z "$HAS_OWNER" ]; then
                    echo "##[error]Missing required permission: Owner role at Tenant Root Management Group"
                    echo "Service principal needs Owner role at: /providers/Microsoft.Management/managementGroups/$TENANT_ROOT_MG"
                    echo "Assign with: az role assignment create --assignee <sp-object-id> --role Owner --scope \"/providers/Microsoft.Management/managementGroups/$TENANT_ROOT_MG\""
                    exit 1
                  fi
                  echo "✓ Owner role at Tenant Root MG: OK"
                  
                  # Note: Billing permissions cannot be easily validated via CLI
                  # They must be assigned via Azure Portal and are required for subscription creation
                  echo "##[warning]Billing permissions cannot be validated via CLI."
                  echo "Ensure service principal has billing permissions assigned via Azure Portal:"
                  echo "  - For MCA: Invoice Section Contributor"
                  echo "  - For EA: Enrollment Account Administrator"
                  echo "Missing billing permissions will cause deployment to hang or fail."
                else
                  echo "Existing subscription detected - skipping permission validation."
                fi

          - task: AzureCLI@2
            displayName: "Validate Subscription Vending Deployment"
            inputs:
              azureSubscription: "$(azureServiceConnection)"
              scriptType: "bash"
              scriptLocation: "inlineScript"
              inlineScript: |
                # Construct billing scope from variable group values
                BILLING_SCOPE=""
                if [ -n "$(billingAccountId)" ]; then
                  if [ -n "$(invoiceSectionId)" ] && [ -n "$(billingProfileId)" ]; then
                    # MCA billing scope format (requires billing profile)
                    BILLING_SCOPE="/providers/Microsoft.Billing/billingAccounts/$(billingAccountId)/billingProfiles/$(billingProfileId)/invoiceSections/$(invoiceSectionId)"
                  elif [ -n "$(enrollmentAccountId)" ]; then
                    # EA billing scope format
                    BILLING_SCOPE="/providers/Microsoft.Billing/billingAccounts/$(billingAccountId)/enrollmentAccounts/$(enrollmentAccountId)"
                  fi
                fi

                # Get existing subscription ID from lookup step (may be empty)
                EXISTING_SUB_ID="$(LookupSubscription.EXISTING_SUBSCRIPTION_ID)"

                az deployment tenant validate \
                  --location "$(deploymentLocation)" \
                  --template-file "$(templateFile)" \
                  --parameters "$(parametersFile)" \
                  --parameters projectName="${{ parameters.projectName }}" \
                  --parameters managementGroupId="${{ parameters.managementGroupId }}" \
                  --parameters billingScope="$BILLING_SCOPE" \
                  --parameters workload="${{ parameters.workload }}" \
                  --parameters workloadAlias="${{ parameters.workloadAlias }}" \
                  --parameters environment="${{ parameters.environment }}" \
                  --parameters locationCode="${{ parameters.locationCode }}" \
                  --parameters instanceNumber="${{ parameters.instanceNumber }}" \
                  --parameters owner="${{ parameters.owner }}" \
                  --parameters managedBy="${{ parameters.managedBy }}" \
                  --parameters existingSubscriptionId="$EXISTING_SUB_ID"

  - stage: WhatIf
    displayName: "What-If Analysis"
    dependsOn:
      - Validate
    # Runs for: WhatIf, Deploy
    condition: |
      and(
        eq(dependencies.Validate.result, 'Succeeded'),
        in('${{ parameters.deploymentStage }}', 'WhatIf', 'Deploy')
      )
    jobs:
      - job: WhatIfAnalysis
        displayName: "What-If"
        timeoutInMinutes: 25
        steps:
          - checkout: self

          - task: AzureCLI@2
            name: LookupSubscription
            displayName: "Lookup Existing Subscription"
            inputs:
              azureSubscription: "$(azureServiceConnection)"
              scriptType: "bash"
              scriptLocation: "inlineScript"
              inlineScript: |
                bash $(scriptsPath)/lookup-subscription.sh \
                  "${{ parameters.projectName }}" \
                  "${{ parameters.workloadAlias }}" \
                  "${{ parameters.environment }}" \
                  "${{ parameters.locationCode }}" \
                  "${{ parameters.instanceNumber }}"

          - task: AzureCLI@2
            displayName: "What-If Subscription Vending Deployment"
            inputs:
              azureSubscription: "$(azureServiceConnection)"
              scriptType: "bash"
              scriptLocation: "inlineScript"
              inlineScript: |
                # Construct billing scope from variable group values
                BILLING_SCOPE=""
                if [ -n "$(billingAccountId)" ]; then
                  if [ -n "$(invoiceSectionId)" ] && [ -n "$(billingProfileId)" ]; then
                    # MCA billing scope format (requires billing profile)
                    BILLING_SCOPE="/providers/Microsoft.Billing/billingAccounts/$(billingAccountId)/billingProfiles/$(billingProfileId)/invoiceSections/$(invoiceSectionId)"
                  elif [ -n "$(enrollmentAccountId)" ]; then
                    # EA billing scope format
                    BILLING_SCOPE="/providers/Microsoft.Billing/billingAccounts/$(billingAccountId)/enrollmentAccounts/$(enrollmentAccountId)"
                  fi
                fi

                # Get existing subscription ID from lookup step (may be empty)
                EXISTING_SUB_ID="$(LookupSubscription.EXISTING_SUBSCRIPTION_ID)"

                az deployment tenant what-if \
                  --location "$(deploymentLocation)" \
                  --template-file "$(templateFile)" \
                  --parameters "$(parametersFile)" \
                  --parameters projectName="${{ parameters.projectName }}" \
                  --parameters managementGroupId="${{ parameters.managementGroupId }}" \
                  --parameters billingScope="$BILLING_SCOPE" \
                  --parameters workload="${{ parameters.workload }}" \
                  --parameters workloadAlias="${{ parameters.workloadAlias }}" \
                  --parameters environment="${{ parameters.environment }}" \
                  --parameters locationCode="${{ parameters.locationCode }}" \
                  --parameters instanceNumber="${{ parameters.instanceNumber }}" \
                  --parameters owner="${{ parameters.owner }}" \
                  --parameters managedBy="${{ parameters.managedBy }}" \
                  --parameters existingSubscriptionId="$EXISTING_SUB_ID"

  - stage: Deploy
    displayName: "Deploy Subscription Vending"
    dependsOn:
      - Validate
      - WhatIf
    # Runs for: Deploy only
    condition: |
      and(
        eq(dependencies.Validate.result, 'Succeeded'),
        in(dependencies.WhatIf.result, 'Succeeded', 'Skipped'),
        eq('${{ parameters.deploymentStage }}', 'Deploy')
      )
    jobs:
      - deployment: DeploySubscriptionVending
        displayName: "Deploy Subscription Vending"
        timeoutInMinutes: 90
        environment: "${{ parameters.environment }}"
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - task: AzureCLI@2
                  name: LookupSubscription
                  displayName: "Lookup Existing Subscription"
                  inputs:
                    azureSubscription: "$(azureServiceConnection)"
                    scriptType: "bash"
                    scriptLocation: "inlineScript"
                    inlineScript: |
                      bash $(scriptsPath)/lookup-subscription.sh \
                        "${{ parameters.workloadAlias }}" \
                        "${{ parameters.environment }}" \
                        "${{ parameters.locationCode }}" \
                        "${{ parameters.instanceNumber }}"

                - task: AzureCLI@2
                  displayName: "Validate Permissions for Subscription Creation"
                  inputs:
                    azureSubscription: "$(azureServiceConnection)"
                    scriptType: "bash"
                    scriptLocation: "inlineScript"
                    inlineScript: |
                      # Get existing subscription ID from lookup step
                      EXISTING_SUB_ID="$(LookupSubscription.EXISTING_SUBSCRIPTION_ID)"

                      # Only validate permissions when creating new subscriptions
                      if [ -z "$EXISTING_SUB_ID" ]; then
                        echo "Validating permissions for new subscription creation..."
                        
                        # Get current service principal object ID
                        SP_OBJECT_ID=$(az ad signed-in-user show --query id -o tsv 2>/dev/null || az account show --query user.name -o tsv)
                        if [ -z "$SP_OBJECT_ID" ]; then
                          echo "##[warning]Could not determine service principal identity. Skipping permission validation."
                          exit 0
                        fi
                        
                        # Get tenant root management group
                        TENANT_ROOT_MG=$(az account management-group list \
                          --query "[?displayName=='Tenant Root Group'].name" -o tsv 2>/dev/null || echo "")
                        
                        if [ -z "$TENANT_ROOT_MG" ]; then
                          echo "##[warning]Could not determine tenant root management group. Skipping permission validation."
                          exit 0
                        fi
                        
                        # Check for Owner role at Tenant Root MG
                        echo "Checking for Owner role at Tenant Root MG..."
                        HAS_OWNER=$(az role assignment list \
                          --assignee "$SP_OBJECT_ID" \
                          --scope "/providers/Microsoft.Management/managementGroups/$TENANT_ROOT_MG" \
                          --query "[?roleDefinitionName=='Owner']" -o tsv 2>/dev/null || echo "")
                        
                        if [ -z "$HAS_OWNER" ]; then
                          echo "##[error]Missing required permission: Owner role at Tenant Root Management Group"
                          echo "Service principal needs Owner role at: /providers/Microsoft.Management/managementGroups/$TENANT_ROOT_MG"
                          echo "Assign with: az role assignment create --assignee <sp-object-id> --role Owner --scope \"/providers/Microsoft.Management/managementGroups/$TENANT_ROOT_MG\""
                          exit 1
                        fi
                        echo "✓ Owner role at Tenant Root MG: OK"
                        
                        # Note: Billing permissions cannot be easily validated via CLI
                        # They must be assigned via Azure Portal and are required for subscription creation
                        echo "##[warning]Billing permissions cannot be validated via CLI."
                        echo "Ensure service principal has billing permissions assigned via Azure Portal:"
                        echo "  - For MCA: Invoice Section Contributor"
                        echo "  - For EA: Enrollment Account Administrator"
                        echo "Missing billing permissions will cause deployment to hang or fail."
                      else
                        echo "Existing subscription detected - skipping permission validation."
                      fi

                - task: AzureCLI@2
                  displayName: "Deploy Subscription Vending"
                  inputs:
                    azureSubscription: "$(azureServiceConnection)"
                    scriptType: "bash"
                    scriptLocation: "inlineScript"
                    inlineScript: |
                      # Construct billing scope from variable group values
                      BILLING_SCOPE=""
                      if [ -n "$(billingAccountId)" ]; then
                        if [ -n "$(invoiceSectionId)" ] && [ -n "$(billingProfileId)" ]; then
                          # MCA billing scope format (requires billing profile)
                          BILLING_SCOPE="/providers/Microsoft.Billing/billingAccounts/$(billingAccountId)/billingProfiles/$(billingProfileId)/invoiceSections/$(invoiceSectionId)"
                        elif [ -n "$(enrollmentAccountId)" ]; then
                          # EA billing scope format
                          BILLING_SCOPE="/providers/Microsoft.Billing/billingAccounts/$(billingAccountId)/enrollmentAccounts/$(enrollmentAccountId)"
                        fi
                      fi

                      # Get existing subscription ID from lookup step (may be empty)
                      EXISTING_SUB_ID="$(LookupSubscription.EXISTING_SUBSCRIPTION_ID)"

                      # Validate billing scope is provided for new subscription creation
                      if [ -z "$EXISTING_SUB_ID" ] && [ -z "$BILLING_SCOPE" ]; then
                        echo "##[error]billingScope is required for new subscription creation but was not provided."
                        echo "Please ensure billing variables are set in the variable group:"
                        echo "  - billingAccountId (required)"
                        echo "  - For MCA: invoiceSectionId and billingProfileId"
                        echo "  - For EA: enrollmentAccountId"
                        exit 1
                      fi

                      # Deployment name for tracking
                      DEPLOYMENT_NAME="sub-vending-$(Build.BuildNumber)"

                      echo "Starting subscription vending deployment: ${DEPLOYMENT_NAME}"
                      if [ -z "$EXISTING_SUB_ID" ]; then
                        echo "Creating NEW subscription with billing scope: ${BILLING_SCOPE}"
                        echo "Note: Subscription creation is asynchronous and may take 30-90 minutes to complete."
                      else
                        echo "Moving existing subscription to management group."
                      fi

                      # Start deployment with --no-wait to avoid blocking on subscription provisioning
                      az deployment tenant create \
                        --name "${DEPLOYMENT_NAME}" \
                        --location "$(deploymentLocation)" \
                        --template-file "$(templateFile)" \
                        --parameters "$(parametersFile)" \
                        --parameters projectName="${{ parameters.projectName }}" \
                        --parameters managementGroupId="${{ parameters.managementGroupId }}" \
                        --parameters billingScope="$BILLING_SCOPE" \
                        --parameters workload="${{ parameters.workload }}" \
                        --parameters workloadAlias="${{ parameters.workloadAlias }}" \
                        --parameters environment="${{ parameters.environment }}" \
                        --parameters locationCode="${{ parameters.locationCode }}" \
                        --parameters instanceNumber="${{ parameters.instanceNumber }}" \
                        --parameters owner="${{ parameters.owner }}" \
                        --parameters managedBy="${{ parameters.managedBy }}" \
                        --parameters existingSubscriptionId="$EXISTING_SUB_ID" \
                        --no-wait

                      if [ $? -ne 0 ]; then
                        echo "##[error]Failed to start deployment"
                        exit 1
                      fi

                      echo "✓ Deployment started successfully. Polling for completion..."

                      # Poll deployment status until it completes or times out
                      # Subscription provisioning can take 30-90 minutes
                      MAX_WAIT_SECONDS=5400  # 90 minutes
                      BASE_POLL_INTERVAL=60  # Base check interval: 60 seconds
                      HEARTBEAT_INTERVAL=300 # Log heartbeat every 5 minutes
                      ELAPSED=0
                      LAST_STATUS=""
                      LAST_HEARTBEAT=0
                      POLL_INTERVAL=$BASE_POLL_INTERVAL
                      RATE_LIMIT_DETECTED=false
                      RATE_LIMIT_COUNT=0
                      MAX_RATE_LIMIT_BACKOFF=600  # Maximum backoff: 10 minutes

                      # Function to check for rate limiting (HTTP 429) in deployment operations
                      check_rate_limiting() {
                        local deployment_name=$1
                        # Query deployment operations and filter for 429 status codes using jq
                        local operations=$(az rest --method GET \
                          --url "https://management.azure.com/providers/Microsoft.Resources/deployments/${deployment_name}/operations?api-version=2022-09-01" \
                          --output json 2>/dev/null | jq '[.value[]? | select(.properties.statusCode == 429)]' 2>/dev/null || echo "[]")
                        
                        if [ "$operations" != "[]" ] && [ -n "$operations" ]; then
                          local count=$(echo "$operations" | jq 'length' 2>/dev/null || echo "0")
                          if [ "$count" -gt 0 ]; then
                            return 0  # Rate limiting detected
                          fi
                        fi
                        return 1  # No rate limiting
                      }

                      while [ $ELAPSED -lt $MAX_WAIT_SECONDS ]; do
                        # Get current deployment status
                        STATUS=$(az deployment tenant show \
                          --name "${DEPLOYMENT_NAME}" \
                          --query "properties.provisioningState" \
                          --output tsv 2>/dev/null || echo "Unknown")

                        # Check for rate limiting in deployment operations
                        if check_rate_limiting "${DEPLOYMENT_NAME}"; then
                          if [ "$RATE_LIMIT_DETECTED" = false ]; then
                            echo "##[warning]Rate limiting (HTTP 429) detected in deployment operations"
                            echo "Azure is throttling requests. This is normal for subscription creation."
                            echo "Implementing exponential backoff to reduce request frequency..."
                            RATE_LIMIT_DETECTED=true
                          fi
                          
                          RATE_LIMIT_COUNT=$((RATE_LIMIT_COUNT + 1))
                          # Exponential backoff: 60s, 120s, 240s, 480s, max 600s (10 minutes)
                          NEW_INTERVAL=$((BASE_POLL_INTERVAL * (2 ** (RATE_LIMIT_COUNT - 1))))
                          if [ $NEW_INTERVAL -gt $MAX_RATE_LIMIT_BACKOFF ]; then
                            NEW_INTERVAL=$MAX_RATE_LIMIT_BACKOFF
                          fi
                          
                          if [ $NEW_INTERVAL -gt $POLL_INTERVAL ]; then
                            POLL_INTERVAL=$NEW_INTERVAL
                            MINUTES=$((POLL_INTERVAL / 60))
                            echo "##[warning]Rate limiting persists. Increasing poll interval to ${MINUTES} minutes"
                            echo "This helps avoid further throttling. Deployment will continue automatically."
                          fi
                        else
                          # No rate limiting detected - reset if we were backing off
                          if [ "$RATE_LIMIT_DETECTED" = true ]; then
                            echo "##[info]Rate limiting cleared. Resetting to normal poll interval"
                            RATE_LIMIT_DETECTED=false
                            RATE_LIMIT_COUNT=0
                            POLL_INTERVAL=$BASE_POLL_INTERVAL
                          fi
                        fi

                        # Log when status changes
                        if [ "$STATUS" != "$LAST_STATUS" ]; then
                          if [ "$RATE_LIMIT_DETECTED" = true ]; then
                            echo "Deployment status: ${STATUS} (elapsed: ${ELAPSED}s / ${MAX_WAIT_SECONDS}s) [Rate limited - polling every ${POLL_INTERVAL}s]"
                          else
                            echo "Deployment status: ${STATUS} (elapsed: ${ELAPSED}s / ${MAX_WAIT_SECONDS}s)"
                          fi
                          LAST_STATUS="$STATUS"
                          LAST_HEARTBEAT=$ELAPSED
                        # Log heartbeat periodically even if status hasn't changed (every 5 minutes)
                        elif [ $((ELAPSED - LAST_HEARTBEAT)) -ge $HEARTBEAT_INTERVAL ]; then
                          MINUTES=$((ELAPSED / 60))
                          if [ "$RATE_LIMIT_DETECTED" = true ]; then
                            echo "##[debug]Still polling... Status: ${STATUS} (${MINUTES} minutes elapsed) [Rate limited - polling every ${POLL_INTERVAL}s]"
                          else
                            echo "##[debug]Still polling... Status: ${STATUS} (${MINUTES} minutes elapsed)"
                          fi
                          LAST_HEARTBEAT=$ELAPSED
                        fi

                        # Check if deployment completed
                        if [ "$STATUS" == "Succeeded" ]; then
                          echo "##[section]✓ Deployment completed successfully!"
                          
                          if [ "$RATE_LIMIT_DETECTED" = true ]; then
                            echo "Note: Deployment completed despite rate limiting. Azure automatically retried operations."
                          fi
                          
                          # Get deployment outputs for logging
                          OUTPUTS=$(az deployment tenant show \
                            --name "${DEPLOYMENT_NAME}" \
                            --query "properties.outputs" \
                            --output json 2>/dev/null || echo "{}")
                          
                          if [ "$OUTPUTS" != "{}" ] && [ -n "$OUTPUTS" ]; then
                            echo "Deployment outputs:"
                            echo "$OUTPUTS" | jq '.' 2>/dev/null || echo "$OUTPUTS"
                          fi
                          
                          exit 0
                        elif [ "$STATUS" == "Failed" ]; then
                          echo "##[error]Deployment failed!"
                          
                          # Check if failure was due to rate limiting
                          if [ "$RATE_LIMIT_DETECTED" = true ]; then
                            echo "##[warning]Rate limiting was detected during deployment. This may have contributed to the failure."
                            echo "Consider waiting longer or reducing concurrent subscription creation operations."
                          fi
                          
                          # Get error details
                          ERROR=$(az deployment tenant show \
                            --name "${DEPLOYMENT_NAME}" \
                            --query "properties.error" \
                            --output json 2>/dev/null || echo "{}")
                          
                          if [ "$ERROR" != "{}" ] && [ -n "$ERROR" ]; then
                            echo "Error details:"
                            echo "$ERROR" | jq '.' 2>/dev/null || echo "$ERROR"
                          fi
                          
                          # Also check operations for detailed error info
                          echo "Checking deployment operations for additional details..."
                          OPERATIONS=$(az rest --method GET \
                            --url "https://management.azure.com/providers/Microsoft.Resources/deployments/${DEPLOYMENT_NAME}/operations?api-version=2022-09-01" \
                            --query "value[?properties.provisioningState == 'Failed']" \
                            --output json 2>/dev/null || echo "[]")
                          
                          if [ "$OPERATIONS" != "[]" ] && [ -n "$OPERATIONS" ]; then
                            echo "Failed operations:"
                            echo "$OPERATIONS" | jq '.[] | {Resource: .properties.targetResource.resourceName, StatusCode: .properties.statusCode, StatusMessage: .properties.statusMessage}' 2>/dev/null || echo "$OPERATIONS"
                          fi
                          
                          exit 1
                        elif [ "$STATUS" == "Canceled" ]; then
                          echo "##[error]Deployment was canceled"
                          exit 1
                        fi

                        # Wait before next poll (using dynamic interval)
                        sleep $POLL_INTERVAL
                        ELAPSED=$((ELAPSED + POLL_INTERVAL))
                      done

                      # Timeout reached
                      echo "##[error]Deployment did not complete within ${MAX_WAIT_SECONDS} seconds (90 minutes)"
                      echo "Current status: ${STATUS}"

                      if [ "$RATE_LIMIT_DETECTED" = true ]; then
                        echo "##[warning]Rate limiting (HTTP 429) was detected during deployment."
                        echo "Azure was throttling requests, which may have extended the deployment time."
                        echo "The deployment may still be in progress. Azure will continue retrying automatically."
                        echo ""
                        echo "Recommendations:"
                        echo "  1. Check Azure Portal for current deployment status"
                        echo "  2. Wait longer before retrying (rate limits reset over time)"
                        echo "  3. Reduce concurrent subscription creation operations"
                        echo "  4. Consider creating subscriptions during off-peak hours"
                      else
                        echo "The deployment may still be in progress. Check Azure Portal for current status."
                      fi

                      echo "Deployment name: ${DEPLOYMENT_NAME}"
                      exit 1

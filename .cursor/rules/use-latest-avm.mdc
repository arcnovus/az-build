---
description: Always use the latest available Azure Verified Module (AVM) when creating Bicep scripts for resources that have an available AVM
globs: ['**/*.bicep', '**/*.bicepparam']
alwaysApply: true
---

# Azure Verified Module (AVM) Usage Rules

When creating or modifying Bicep scripts, you MUST follow these rules for Azure Verified Modules:

## Always Use Azure Verified Modules When Available

1. **Check for AVM Availability**: Before creating custom Bicep code for an Azure resource, check if an Azure Verified Module (AVM) exists for that resource type.

2. **AVM Registry Location**: Azure Verified Modules are published to the public Bicep registry at `br/public:avm/...`

3. **Module Path Structure**: AVM modules follow this structure:
   - Resource modules: `br/public:avm/res/<resource-type>/<resource-name>:<version>`
   - Pattern modules: `br/public:avm/ptn/<pattern-type>/<pattern-name>:<version>`
   - Example: `br/public:avm/res/storage/storage-account:1.0.0`

## Version Selection from CHANGELOG.md

4. **Always Use Latest Version**: When referencing an AVM, you MUST use the latest available version.

5. **Finding the Latest Version**: To determine the latest version:
   - Navigate to the module's GitHub repository in the Azure/bicep-registry-modules organization
   - Locate the `CHANGELOG.md` file in the module's directory
   - Read the latest version number from the `CHANGELOG.md` file
   - Use this version in the module reference


6. **Module Reference Format**: Always use the format:
   ```bicep
   module <moduleName> 'br/public:avm/<module-path>:<latest-version-from-version.json>' = {
     name: '<deployment-name>'
     params: {
       // parameters
     }
   }
   ```

## Search Process

8. **When Creating New Bicep Files**:
   - First, search the Azure Verified Modules repository (https://github.com/Azure/bicep-registry-modules) for an available module
   - If an AVM exists, use it instead of creating custom code
   - Check the module's ``CHANGELOG.md`` file to get the latest version
   - Reference the module using the latest version from ``CHANGELOG.md``

9. **When Updating Existing Bicep Files**:
   - Review existing module references
   - Check if newer versions are available by comparing against the ``CHANGELOG.md`` file
   - Update to the latest version if a newer one exists

## Examples

**Correct Usage:**
```bicep
// Latest version from `CHANGELOG.md`(e.g., 0.5.3)
module subVending 'br/public:avm/ptn/lz/sub-vending:0.5.3' = {
  name: 'sub-vending-example'
  params: {
    subscriptionDisplayName: 'My Subscription'
    // ... other params
  }
}
```

**Incorrect Usage:**
```bicep
// ❌ Using an outdated version
module subVending 'br/public:avm/ptn/lz/sub-vending:0.3.0' = {
  // ...
}

// ❌ Creating custom code when an AVM exists
resource storageAccount 'Microsoft.Storage/storageAccounts@2023-01-01' = {
  // Custom code instead of using AVM
}
```

## Verification

10. **Before Committing**: Verify that:
    - All AVM references use the latest version from ``CHANGELOG.md``
    - No custom code exists for resources that have available AVMs
    - Module paths follow the correct AVM structure
